<html lang="zh">
<head>
<meta charset="UTF-8"/>
<title>es</title>
<script src="js/jquery-3.1.1.js"></script>
</head>
<noscript><h2 style="color: #e80b0a;">Sorry，浏览器不支持WebSocket</h2></noscript>
<body>
<div>
<p id="data"></p>
</div>
</body>
<script type="text/javascript">
    $(function() {
  /*      const eventSource = new EventSource("/event-stream");
        const dataDiv = $('#data');
        eventSource.onmessage = function(event) {
            console.log('Received message:'+event.data);
            dataDiv.append(event.data);
        };
        eventSource.onerror = function(error) {
            console.error('EventSource failed:'+error);
            dataDiv.append(error);
            eventSource.close();
        };*/
        const dataDiv = $('#data');
        // 准备要发送的数据
        const data = new FormData();
        data.append('key1', 'value1');
        data.append('key2', 'value2');

// 发送 POST 请求并处理响应
        fetch('/event-stream', {
            method: 'POST',
            body: data
        }).then(response => {
                // 检查响应是否为 SSE 流
                if (response.headers.get('Content-Type') === 'text/event-stream') {
                    // 返回一个可读流以读取响应体
                    return response.body.getReader();
                } else {
                    throw new Error('Response is not an SSE stream');
                }
            }).then(reader => {
                // 递归处理 SSE 事件的函数
                function processSSEEvent(reader) {
                    return reader.read().then(({done, value}) => {
                        if (done) {
                            console.log('SSE stream ended');
                            return;
                        }
                        // value 是一个包含数据的 Uint8Array
                        const eventStr = new TextDecoder().decode(value);
                      //  const event = eventStr.trim();
                        // 处理事件（例如，解析为 JSON，如果事件是 JSON 格式）
                        console.log('Received SSE event:', eventStr);
                        const event = eventStr.replace(/^data:/, '');
                        dataDiv.append(event);
                        // 继续读取下一个事件
                        return processSSEEvent(reader);
                    });
                }
                // 开始处理 SSE 事件
                return processSSEEvent(reader);
            }).catch(error => {
                console.error('Error fetching SSE stream:', error);
            })
    });
</script>
</html>
